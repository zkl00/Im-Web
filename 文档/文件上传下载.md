# 文件上传下载 API 文档

本文档描述 KKIM IM 系统中文件上传和下载相关的 API 接口。

## 目录

- [概述](#概述)
- [通用说明](#通用说明)
- [上传流程](#上传流程)
- [API 接口](#api-接口)
  - [获取分片限制 (PartLimit)](#1-获取分片限制-partlimit)
  - [计算分片大小 (PartSize)](#2-计算分片大小-partsize)
  - [初始化分片上传 (InitiateMultipartUpload)](#3-初始化分片上传-initiatemultipartupload)
  - [获取上传签名 (AuthSign)](#4-获取上传签名-authsign)
  - [完成分片上传 (CompleteMultipartUpload)](#5-完成分片上传-completemultipartupload)
  - [初始化表单上传 (InitiateFormData)](#6-初始化表单上传-initiateformdata)
  - [完成表单上传 (CompleteFormData)](#7-完成表单上传-completeformdata)
  - [获取文件访问URL (AccessURL)](#8-获取文件访问url-accessurl)
  - [直接访问/下载文件](#9-直接访问下载文件)
- [错误码](#错误码)
- [使用示例](#使用示例)

---

## 概述

系统支持两种文件上传方式：
1. **分片上传 (Multipart Upload)**: 适用于大文件，支持断点续传
2. **表单上传 (Form Data Upload)**: 适用于小文件，流程简单

## 通用说明

### 请求头

所有 API 请求需要包含以下请求头：

| 参数名 | 类型 | 必填 | 说明                                      |
|--------|------|------|-----------------------------------------|
| `token` | string | 是 | 用户认证令牌                                  |
| `operationID` | string | 是 | 操作唯一标识，用于追踪请求                           |
| `X-Request-Api` | string | 否 | 自定义 API 前缀地址(CDN加速，自定义域名的时候用到，暂传服务器的ip) |

### 响应格式

```json
{
  "errCode": 0,
  "errMsg": "",
  "errDlt": "",
  "data": { ... }
}
```

## 上传流程

### 分片上传流程

```
1. 调用 PartSize 计算推荐分片大小 (使用系统推荐值则无需调用 PartLimit)
2. 调用 InitiateMultipartUpload 初始化上传
   - 如果返回 url，说明文件已存在(秒传)，流程结束
   - 如果返回 upload 信息，继续后续步骤
3. 使用签名信息上传各个分片到 S3
4. 如需额外分片签名，调用 AuthSign 获取
5. 所有分片上传完成后，调用 CompleteMultipartUpload 完成上传
```

> **注意**: `PartLimit` 接口仅在需要自定义分片策略时使用。如果直接使用 `PartSize` 返回的推荐分片大小，则无需调用 `PartLimit`。

### 表单上传流程

```
1. 调用 InitiateFormData 获取表单上传信息
2. 使用返回的表单数据直接 POST 到 S3
3. 调用 CompleteFormData 完成上传，获取文件访问 URL
```

---

## API 接口

### 1. 获取分片限制 (PartLimit)

获取 S3 存储的分片大小限制参数。

**接口路径**: `POST /object/part_limit`

**功能**: 获取文件分片上传的最小分片大小、最大分片大小和最大分片数量限制

**使用场景**: 在进行大文件分片上传前，先获取系统限制参数，用于客户端计算分片策略

#### 请求参数

无需请求体参数

#### 请求示例

```bash
curl -X POST 'http://api.example.com/object/part_limit' \
  -H 'token: your_token_here' \
  -H 'operationID: unique_operation_id' \
  -H 'Content-Type: application/json'
```

#### 响应参数

| 参数名 | 类型 | 说明 |
|--------|------|------|
| minPartSize | int64 | 最小分片大小(字节) |
| maxPartSize | int64 | 最大分片大小(字节) |
| maxNumSize | int32 | 最大分片数量 |

#### 响应示例

```json
{
  "errCode": 0,
  "errMsg": "",
  "data": {
    "minPartSize": 5242880,
    "maxPartSize": 5368709120,
    "maxNumSize": 10000
  }
}
```

---

### 2. 计算分片大小 (PartSize)

根据文件总大小计算推荐的分片大小。

**接口路径**: `POST /object/part_size`

**功能**: 根据文件大小计算最优的分片大小，确保分片数量不超过系统限制

**使用场景**: 上传大文件前，根据文件大小获取系统推荐的分片大小

#### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| size | int64 | 是 | 文件总大小(字节) |

#### 请求示例

```bash
curl -X POST 'http://api.example.com/object/part_size' \
  -H 'token: your_token_here' \
  -H 'operationID: unique_operation_id' \
  -H 'Content-Type: application/json' \
  -d '{
    "size": 104857600
  }'
```

#### 响应参数

| 参数名 | 类型 | 说明 |
|--------|------|------|
| size | int64 | 推荐的分片大小(字节) |

#### 响应示例

```json
{
  "errCode": 0,
  "errMsg": "",
  "data": {
    "size": 10485760
  }
}
```

---

### 3. 初始化分片上传 (InitiateMultipartUpload)

初始化分片上传会话。

**接口路径**: `POST /object/initiate_multipart_upload`

**功能**:
- 初始化分片上传会话，获取上传 ID 和签名信息
- 支持秒传：如果文件哈希已存在，直接返回文件 URL

**使用场景**: 上传大文件(如视频、大型文档)的第一步

#### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| hash | string | 是 | 文件 MD5 哈希值 |
| size | int64 | 是 | 文件总大小(字节) |
| maxParts | int32 | 是 | 期望的最大分片数 |
| cause | string | 否 | 上传原因/分组标识 |
| name | string | 是 | 文件名(含路径) |
| contentType | string | 否 | 文件 MIME 类型 |

#### 请求示例

```bash
curl -X POST 'http://api.example.com/object/initiate_multipart_upload' \
  -H 'token: your_token_here' \
  -H 'operationID: unique_operation_id' \
  -H 'Content-Type: application/json' \
  -d '{
    "hash": "d41d8cd98f00b204e9800998ecf8427e",
    "size": 104857600,
    "maxParts": 10,
    "cause": "chat",
    "name": "video/my_video.mp4",
    "contentType": "video/mp4"
  }'
```

#### 响应参数

**秒传成功时**:

| 参数名 | 类型 | 说明 |
|--------|------|------|
| url | string | 文件访问 URL(秒传成功) |

**需要上传时**:

| 参数名 | 类型 | 说明 |
|--------|------|------|
| upload | object | 上传信息对象 |
| upload.uploadID | string | 上传会话 ID |
| upload.partSize | int64 | 实际分片大小(字节) |
| upload.sign | object | 签名信息 |
| upload.sign.url | string | 上传基础 URL |
| upload.sign.query | object | URL 查询参数 |
| upload.sign.header | object | 请求头参数 |
| upload.sign.parts | array | 各分片签名信息 |
| upload.expireTime | int64 | 签名过期时间(毫秒时间戳) |

#### 响应示例

**秒传成功**:
```json
{
  "errCode": 0,
  "errMsg": "",
  "data": {
    "url": "http://api.example.com/object/video/my_video.mp4"
  }
}
```

**需要上传**:
```json
{
  "errCode": 0,
  "errMsg": "",
  "data": {
    "upload": {
      "uploadID": "upload_abc123",
      "partSize": 10485760,
      "sign": {
        "url": "https://s3.example.com/bucket",
        "query": {},
        "header": {
          "Authorization": ["AWS4-HMAC-SHA256 ..."]
        },
        "parts": [
          {
            "partNumber": 1,
            "url": "https://s3.example.com/bucket?partNumber=1",
            "query": {"partNumber": ["1"]},
            "header": {}
          }
        ]
      },
      "expireTime": 1703505600000
    }
  }
}
```

---

### 4. 获取上传签名 (AuthSign)

获取指定分片的上传签名。

**接口路径**: `POST /object/auth_sign`

**功能**: 为指定的分片获取上传签名，用于签名过期后重新获取签名

**使用场景**:
- 初始化上传返回的签名不包含所有分片时
- 签名过期需要重新获取时
- 断点续传时获取剩余分片的签名

#### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| uploadID | string | 是 | 上传会话 ID |
| partNumbers | array[int32] | 是 | 需要签名的分片编号列表 |

#### 请求示例

```bash
curl -X POST 'http://api.example.com/object/auth_sign' \
  -H 'token: your_token_here' \
  -H 'operationID: unique_operation_id' \
  -H 'Content-Type: application/json' \
  -d '{
    "uploadID": "upload_abc123",
    "partNumbers": [5, 6, 7, 8, 9, 10]
  }'
```

#### 响应参数

| 参数名 | 类型 | 说明 |
|--------|------|------|
| url | string | 上传基础 URL |
| query | object | URL 查询参数 |
| header | object | 请求头参数 |
| parts | array | 各分片签名信息 |
| parts[].partNumber | int32 | 分片编号 |
| parts[].url | string | 分片上传 URL |
| parts[].query | object | 分片查询参数 |
| parts[].header | object | 分片请求头 |

#### 响应示例

```json
{
  "errCode": 0,
  "errMsg": "",
  "data": {
    "url": "https://s3.example.com/bucket",
    "query": {},
    "header": {},
    "parts": [
      {
        "partNumber": 5,
        "url": "https://s3.example.com/bucket?partNumber=5&uploadId=xxx",
        "query": {"partNumber": ["5"]},
        "header": {"Authorization": ["..."]}
      }
    ]
  }
}
```

---

### 5. 完成分片上传 (CompleteMultipartUpload)

完成分片上传，合并所有分片。

**接口路径**: `POST /object/complete_multipart_upload`

**功能**: 通知服务端所有分片已上传完成，合并分片并生成最终文件

**使用场景**: 所有分片上传完成后，调用此接口完成整个上传流程

#### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| uploadID | string | 是 | 上传会话 ID |
| parts | array[string] | 是 | 各分片的 ETag 值列表(按分片顺序) |
| name | string | 是 | 文件名(需与初始化时一致) |
| contentType | string | 否 | 文件 MIME 类型 |
| cause | string | 否 | 上传原因/分组标识 |

#### 请求示例

```bash
curl -X POST 'http://api.example.com/object/complete_multipart_upload' \
  -H 'token: your_token_here' \
  -H 'operationID: unique_operation_id' \
  -H 'Content-Type: application/json' \
  -d '{
    "uploadID": "upload_abc123",
    "parts": [
      "etag1_xxxxx",
      "etag2_xxxxx",
      "etag3_xxxxx"
    ],
    "name": "video/my_video.mp4",
    "contentType": "video/mp4",
    "cause": "chat"
  }'
```

#### 响应参数

| 参数名 | 类型 | 说明 |
|--------|------|------|
| url | string | 文件访问 URL |

#### 响应示例

```json
{
  "errCode": 0,
  "errMsg": "",
  "data": {
    "url": "http://api.example.com/object/video/my_video.mp4"
  }
}
```

---

### 6. 初始化表单上传 (InitiateFormData)

初始化表单方式上传。

**接口路径**: `POST /object/initiate_form_data`

**功能**: 获取表单上传所需的签名信息和表单字段，适用于小文件直接上传

**使用场景**:
- 上传小文件(如图片、头像、文档等)
- 需要简单快速的上传流程

#### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| name | string | 是 | 文件名(含路径) |
| size | int64 | 是 | 文件大小(字节) |
| contentType | string | 否 | 文件 MIME 类型 |
| group | string | 否 | 分组标识(如: chat, avatar) |
| millisecond | int64 | 否 | 签名有效期(毫秒，管理员可用) |
| absolute | bool | 否 | 是否使用绝对路径(管理员可用) |

#### 请求示例

```bash
curl -X POST 'http://api.example.com/object/initiate_form_data' \
  -H 'token: your_token_here' \
  -H 'operationID: unique_operation_id' \
  -H 'Content-Type: application/json' \
  -d '{
    "name": "images/avatar.jpg",
    "size": 102400,
    "contentType": "image/jpeg",
    "group": "avatar"
  }'
```

#### 响应参数

| 参数名 | 类型 | 说明 |
|--------|------|------|
| id | string | 上传会话 ID(Base64编码) |
| url | string | 表单提交 URL |
| file | string | 文件字段名 |
| header | object | 请求头参数 |
| formData | object | 表单字段键值对 |
| expires | int64 | 签名过期时间(毫秒时间戳) |
| successCodes | array[int32] | 成功状态码列表 |

#### 响应示例

```json
{
  "errCode": 0,
  "errMsg": "",
  "data": {
    "id": "eyJuYW1lIjoiaW1hZ2VzL2F2YXRhci5qcGciLC...",
    "url": "https://s3.example.com/bucket",
    "file": "file",
    "header": {},
    "formData": {
      "key": "direct/20231225/user123/abc123.jpg",
      "policy": "eyJleHBpcmF0aW9uIjo...",
      "x-amz-signature": "abc123...",
      "x-amz-algorithm": "AWS4-HMAC-SHA256",
      "x-amz-credential": "...",
      "x-amz-date": "20231225T000000Z"
    },
    "expires": 1703505600000,
    "successCodes": [200, 201, 204]
  }
}
```

#### 使用表单上传到 S3

```javascript
const formData = new FormData();
// 按顺序添加表单字段
for (const [key, value] of Object.entries(response.formData)) {
  formData.append(key, value);
}
// 最后添加文件
formData.append(response.file, fileBlob, filename);

// POST 到返回的 URL
fetch(response.url, {
  method: 'POST',
  body: formData
});
```

---

### 7. 完成表单上传 (CompleteFormData)

完成表单上传，获取文件访问 URL。

**接口路径**: `POST /object/complete_form_data`

**功能**: 表单上传到 S3 成功后，调用此接口完成上传，获取文件访问 URL

**使用场景**: 通过表单方式上传文件到 S3 成功后，调用此接口获取可访问的文件 URL

#### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| id | string | 是 | 上传会话 ID(InitiateFormData 返回) |

#### 请求示例

```bash
curl -X POST 'http://api.example.com/object/complete_form_data' \
  -H 'token: your_token_here' \
  -H 'operationID: unique_operation_id' \
  -H 'Content-Type: application/json' \
  -d '{
    "id": "eyJuYW1lIjoiaW1hZ2VzL2F2YXRhci5qcGciLC..."
  }'
```

#### 响应参数

| 参数名 | 类型 | 说明 |
|--------|------|------|
| url | string | 文件访问 URL |

#### 响应示例

```json
{
  "errCode": 0,
  "errMsg": "",
  "data": {
    "url": "http://api.example.com/object/images/avatar.jpg"
  }
}
```

---

### 8. 获取文件访问URL (AccessURL)

获取文件的临时访问 URL。

**接口路径**: `POST /object/access_url`

**功能**:
- 获取文件的带签名临时访问 URL
- 支持图片处理参数(缩放、格式转换等)

**使用场景**:
- 获取私有文件的临时访问链接
- 获取图片缩略图 URL

#### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| name | string | 是 | 文件名(含路径) |
| query | object | 否 | 查询参数 |
| query.type | string | 否 | 处理类型: "image" |
| query.format | string | 否 | 图片格式: jpg, png, webp 等 |
| query.width | string | 否 | 图片宽度 |
| query.height | string | 否 | 图片高度 |

#### 请求示例

**获取原文件 URL**:
```bash
curl -X POST 'http://api.example.com/object/access_url' \
  -H 'token: your_token_here' \
  -H 'operationID: unique_operation_id' \
  -H 'Content-Type: application/json' \
  -d '{
    "name": "images/photo.jpg"
  }'
```

**获取缩略图 URL**:
```bash
curl -X POST 'http://api.example.com/object/access_url' \
  -H 'token: your_token_here' \
  -H 'operationID: unique_operation_id' \
  -H 'Content-Type: application/json' \
  -d '{
    "name": "images/photo.jpg",
    "query": {
      "type": "image",
      "format": "webp",
      "width": "200",
      "height": "200"
    }
  }'
```

#### 响应参数

| 参数名 | 类型 | 说明 |
|--------|------|------|
| url | string | 文件访问 URL(带签名) |
| expireTime | int64 | URL 过期时间(毫秒时间戳) |

#### 响应示例

```json
{
  "errCode": 0,
  "errMsg": "",
  "data": {
    "url": "https://s3.example.com/bucket/images/photo.jpg?X-Amz-Algorithm=...",
    "expireTime": 1703509200000
  }
}
```

---

### 9. 直接访问/下载文件

通过 URL 直接访问或下载文件。

**接口路径**: `GET /object/{name}`

**功能**: 直接通过浏览器访问文件，自动重定向到 S3 签名 URL

**使用场景**:
- 在浏览器中直接打开文件
- 作为 `<img>` 标签的 src 属性
- 直接下载文件

#### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| name | path | 是 | 文件路径(URL 路径部分) |
| operationID | query | 否 | 操作 ID |
| type | query | 否 | 处理类型: "image" |
| format | query | 否 | 图片格式 |
| width | query | 否 | 图片宽度 |
| height | query | 否 | 图片高度 |

#### 请求示例

**直接访问**:
```
GET http://api.example.com/object/images/photo.jpg
```

**获取缩略图**:
```
GET http://api.example.com/object/images/photo.jpg?type=image&width=100&height=100
```

#### 响应

HTTP 302 重定向到 S3 签名 URL

---

## 错误码

| 错误码 | 错误信息 | 说明 |
|--------|----------|------|
| 0 | success | 成功 |
| 1001 | ArgsError | 参数错误 |
| 1002 | NoPermissionError | 无权限 |
| 1003 | DuplicateKeyError | 重复数据 |
| 1004 | RecordNotFoundError | 记录不存在 |
| 500 | InternalError | 服务器内部错误 |
| 10001 | name is empty | 文件名为空 |
| 10002 | size must be greater than 0 | 文件大小必须大于0 |
| 10003 | id is empty | 上传ID为空 |
| 10004 | invalid id | 无效的上传ID |
| 10005 | file size mismatch | 文件大小不匹配 |
| 10006 | invalid query type | 无效的查询类型 |

---

## 使用示例

### JavaScript 完整上传示例

#### 表单上传(小文件)

```javascript
async function uploadSmallFile(file, token) {
  const API_BASE = 'http://api.example.com';
  const operationID = Date.now().toString();

  // 1. 初始化表单上传
  const initResp = await fetch(`${API_BASE}/object/initiate_form_data`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'token': token,
      'operationID': operationID
    },
    body: JSON.stringify({
      name: `images/${file.name}`,
      size: file.size,
      contentType: file.type,
      group: 'chat'
    })
  });
  const initData = await initResp.json();

  if (initData.errCode !== 0) {
    throw new Error(initData.errMsg);
  }

  // 2. 上传到 S3
  const formData = new FormData();
  for (const [key, value] of Object.entries(initData.data.formData)) {
    formData.append(key, value);
  }
  formData.append(initData.data.file, file, file.name);

  const uploadResp = await fetch(initData.data.url, {
    method: 'POST',
    body: formData
  });

  if (!initData.data.successCodes.includes(uploadResp.status)) {
    throw new Error('Upload to S3 failed');
  }

  // 3. 完成上传
  const completeResp = await fetch(`${API_BASE}/object/complete_form_data`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'token': token,
      'operationID': operationID
    },
    body: JSON.stringify({
      id: initData.data.id
    })
  });
  const completeData = await completeResp.json();

  if (completeData.errCode !== 0) {
    throw new Error(completeData.errMsg);
  }

  return completeData.data.url;
}
```

#### 分片上传(大文件)

```javascript
async function uploadLargeFile(file, token) {
  const API_BASE = 'http://api.example.com';
  const operationID = Date.now().toString();
  const headers = {
    'Content-Type': 'application/json',
    'token': token,
    'operationID': operationID
  };

  // 1. 计算文件 MD5 (简化示例，实际需要使用 SparkMD5 等库)
  const hash = await calculateMD5(file);

  // 2. 获取推荐分片大小
  const partSizeResp = await fetch(`${API_BASE}/object/part_size`, {
    method: 'POST',
    headers,
    body: JSON.stringify({ size: file.size })
  });
  const partSizeData = await partSizeResp.json();
  const partSize = partSizeData.data.size;

  // 3. 计算分片数量
  const totalParts = Math.ceil(file.size / partSize);

  // 4. 初始化分片上传
  const initResp = await fetch(`${API_BASE}/object/initiate_multipart_upload`, {
    method: 'POST',
    headers,
    body: JSON.stringify({
      hash: hash,
      size: file.size,
      maxParts: totalParts,
      name: `videos/${file.name}`,
      contentType: file.type,
      cause: 'chat'
    })
  });
  const initData = await initResp.json();

  // 秒传成功
  if (initData.data.url) {
    return initData.data.url;
  }

  const { uploadID, sign } = initData.data.upload;

  // 5. 上传各分片
  const etags = [];
  for (let i = 0; i < totalParts; i++) {
    const start = i * partSize;
    const end = Math.min(start + partSize, file.size);
    const chunk = file.slice(start, end);

    const partInfo = sign.parts[i];
    const uploadResp = await fetch(partInfo.url, {
      method: 'PUT',
      headers: partInfo.header,
      body: chunk
    });

    etags.push(uploadResp.headers.get('ETag'));
  }

  // 6. 完成上传
  const completeResp = await fetch(`${API_BASE}/object/complete_multipart_upload`, {
    method: 'POST',
    headers,
    body: JSON.stringify({
      uploadID: uploadID,
      parts: etags,
      name: `videos/${file.name}`,
      contentType: file.type,
      cause: 'chat'
    })
  });
  const completeData = await completeResp.json();

  return completeData.data.url;
}
```

---

## 注意事项

1. **文件大小限制**: 表单上传适用于小文件(建议 < 100MB)，大文件请使用分片上传
2. **签名有效期**: 上传签名有有效期限制，请在有效期内完成上传
3. **秒传机制**: 系统会根据文件 MD5 哈希判断文件是否已存在，实现秒传
4. **断点续传**: 分片上传支持断点续传，可以保存 uploadID 和已上传分片的 ETag
5. **图片处理**: 获取图片 URL 时可以指定缩放参数，系统会返回处理后的图片
